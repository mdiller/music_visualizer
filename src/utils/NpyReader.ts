import npyjs from 'npyjs';
import ndarray from 'ndarray';

class NpyReader {
	private npyFile: string;
	private npyArray: any | null;
	private isLoaded: boolean;

	constructor(npyFile: string) {
		this.npyFile = npyFile;
		this.npyArray = null;
		this.isLoaded = false;
		this.loadNpyFile();
	}

	private loadNpyFile(): void {
		const n = new npyjs();
		// console.log("loading npy..")
		// console.time("thing")
		n.load(this.npyFile, response => {
			// console.log("loaded!")
			// console.timeEnd("thing")
			this.npyArray = ndarray(response.data, response.shape);
			this.isLoaded = true;
		});
	}

	public getFrameSvg(index: number, width: number, height: number): string {
		if (!this.isLoaded) {
			console.log('Npy file not loaded yet.');
			return "M0,100 L0,100 L1,100 L2,100 L4,100 L5,100 L6,100 L8,100 L9,100 L11,100 L12,100 L13,100 L15,100 L16,100 L18,100 L19,100 L20,100 L22,100 L23,100 L25,100 L26,100 L27,100 L29,100 L30,100 L31,100 L33,100 L34,100 L36,100 L37,100 L38,100 L40,100 L41,100 L43,100 L44,100 L45,100 L47,100 L48,100 L50,100 L51,100 L52,100 L54,100 L55,100 L56,100 L58,100 L59,100 L61,100 L62,100 L63,100 L65,100 L66,100 L68,100 L69,100 L70,100 L72,100 L73,100 L75,100 L76,100 L77,100 L79,100 L80,100 L81,100 L83,100 L84,100 L86,100 L87,100 L88,100 L90,100 L91,100 L93,100 L94,100 L95,100 L97,100 L98,100 L100,100 L101,100 L102,100 L104,100 L105,100 L106,100 L108,100 L109,100 L111,100 L112,100 L113,100 L115,100 L116,100 L118,100 L119,100 L120,100 L122,100 L123,100 L125,100 L126,100 L127,100 L129,100 L130,100 L131,100 L133,100 L134,100 L136,100 L137,100 L138,100 L140,100 L141,100 L143,100 L144,100 L145,100 L147,100 L148,100 L150,100 L151,100 L152,100 L154,100 L155,100 L156,100 L158,100 L159,100 L161,100 L162,100 L163,100 L165,100 L166,100 L168,100 L169,100 L170,100 L172,100 L173,100 L175,100 L176,100 L177,100 L179,100 L180,100 L181,100 L183,100 L184,100 L186,100 L187,100 L188,100 L190,100 L191,100 L193,100 L194,100 L195,100 L197,100 L198,100 L200,100 L201,100 L202,100 L204,100 L205,100 L206,100 L208,100 L209,100 L211,100 L212,100 L213,100 L215,100 L216,100 L218,100 L219,100 L220,100 L222,100 L223,100 L225,100 L226,100 L227,100 L229,100 L230,100 L231,100 L233,100 L234,100 L236,100 L237,100 L238,100 L240,100 L241,100 L243,100 L244,100 L245,100 L247,100 L248,100 L250,100 L251,100 L252,100 L254,100 L255,100 L256,100 L258,100 L259,100 L261,100 L262,100 L263,100 L265,100 L266,100 L268,100 L269,100 L270,100 L272,100 L273,100 L275,100 L276,100 L277,100 L279,100 L280,100 L281,100 L283,100 L284,100 L286,100 L287,100 L288,100 L290,100 L291,100 L293,100 L294,100 L295,100 L297,100 L298,100 L300,100 L301,100 L302,100 L304,100 L305,100 L306,100 L308,100 L309,100 L311,100 L312,100 L313,100 L315,100 L316,100 L318,100 L319,100 L320,100 L322,100 L323,100 L325,100 L326,100 L327,100 L329,100 L330,100 L331,100 L333,100 L334,100 L336,100 L337,100 L338,100 L340,100 L341,100 L343,100 L344,100 L345,100 L347,94 L348,73 L350,62 L351,81 L352,100 L354,100 L355,93 L356,99 L358,100 L359,100 L361,100 L362,100 L363,100 L365,100 L366,100 L368,100 L369,100 L370,100 L372,100 L373,100 L375,100 L376,100 L377,100 L379,100 L380,100 L381,100 L383,100 L384,100 L386,100 L387,100 L388,100 L390,100 L391,100 L393,100 L394,100 L395,100 L397,100 L398,100 L400,100 L401,100 L402,100 L404,100 L405,100 L406,100 L408,100 L409,100 L411,100 L412,98 L413,89 L415,74 L416,65 L418,89 L419,98 L420,99 L422,100 L423,100 L425,100 L426,100 L427,100 L429,100 L430,100 L431,100 L433,100 L434,100 L436,100 L437,100 L438,100 L440,100 L441,100 L443,100 L444,100 L445,100 L447,100 L448,100 L450,100 L451,100 L452,99 L454,93 L455,92 L456,98 L458,100 L459,100 L461,100 L462,100 L463,100 L465,100 L466,100 L468,100 L469,100 L470,100 L472,100 L473,100 L475,100 L476,100 L477,100 L479,100 L480,100 L481,72 L483,62 L484,85 L486,100 L487,100 L488,100 L490,100 L491,100 L493,100 L494,100 L495,100 L497,100 L498,100 L500,100 L501,100 L502,100 L504,100 L505,100 L506,100 L508,100 L509,100 L511,100 L512,100 L513,100 L515,100 L516,100 L518,100 L519,100 L520,100 L522,100 L523,100 L525,100 L526,100 L527,100 L529,100 L530,100 L531,100 L533,100 L534,100 L536,97 L537,94 L538,100 L540,100 L541,100 L543,100 L544,100 L545,100 L547,100 L548,100 L550,100 L551,100 L552,100 L554,100 L555,100 L556,100 L558,100 L559,100 L561,100 L562,100 L563,100 L565,100 L566,100 L568,100 L569,100 L570,100 L572,100 L573,100 L575,100 L576,100 L577,100 L579,100 L580,100 L581,100 L583,100 L584,100 L586,100 L587,100 L588,100 L590,100 L591,100 L593,100 L594,100 L595,100 L597,100 L598,100L598,100Z";
		}
		if (!this.npyArray) {
			console.error('Npy array not available.');
			return '';
		}

		console.log(width, height);

		var frameLength = this.npyArray.shape[1];
		var xMultiplier = width / frameLength
		
		let d = `M0,${height}`;

		for (var i = 0; i < frameLength; i++) {
			let yValue = height - Math.floor(this.npyArray.get(index, i) * height);
			if (yValue < 0) {
				yValue = 0;
			}
			d += ` L${Math.floor(i * xMultiplier)},${yValue}`;
		}

		d += `L${Math.floor((frameLength - 1) * xMultiplier)},${height}`;
		d += 'Z';

		return d;

	}
}

export default NpyReader;
